echo "ðŸ” Checking for DNS provider API key..."

# Check if DNS_PROVIDER_KEY secret is available
if [ -z "{{{githubVarsOpen}}} secrets.DNS_PROVIDER_KEY  {{{githubVarsClose}}}" ]; then
  echo "âš ï¸ No DNS_PROVIDER_KEY secret found. Skipping automatic DNS management."
  echo "DNS_AUTO_MANAGED=false" >> $GITHUB_OUTPUT
  exit 0
fi

echo "âœ… DNS provider 'cloudflare' detected - will use Cloudflare API for DNS management"
echo "DNS_AUTO_MANAGED=true" >> $GITHUB_OUTPUT
echo "ðŸš€ Attempting to automatically manage DNS records..."

# Get certificate validation data
UI_CERT_ARN="{{{githubVarsOpen}}} steps.create-ssl-cert.outputs.UI_CERTIFICATE_ARN  {{{githubVarsClose}}}"
API_CERT_ARN="{{{githubVarsOpen}}} steps.create-api-ssl-cert.outputs.API_CERTIFICATE_ARN  {{{githubVarsClose}}}"

# Function to get validation records for a certificate
get_validation_records() {
  local cert_arn="$1"
  local region="$2"
  local cert_name="$3"

  echo "ðŸ” Getting $cert_name validation records..."
  local validation_data=$(aws acm describe-certificate --region "$region" --certificate-arn "$cert_arn" \
    --query 'Certificate.DomainValidationOptions[]' --output json 2>/dev/null || echo '[]')

  if [ "$validation_data" = "[]" ] || [ "$validation_data" = "null" ] || [ -z "$validation_data" ]; then
    echo "âš ï¸ No $cert_name validation data available yet"
    return 1
  fi

  # Extract CNAME records that are ready
  echo "$validation_data" | jq -r '.[] |
    if .ResourceRecord != null then
      "\(.DomainName)|\(.ResourceRecord.Name)|\(.ResourceRecord.Value)"
    else
      empty
    end' 2>/dev/null || return 1
}

# Function to check if CNAME record exists in Cloudflare
check_cloudflare_record() {
  local zone_name="$1"
  local record_name="$2"
  local api_token="$3"

  # Get zone ID
  local zone_id=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$zone_name" \
    -H "Authorization: Bearer $api_token" \
    -H "Content-Type: application/json" | jq -r '.result[0].id' 2>/dev/null)

  if [ "$zone_id" = "null" ] || [ -z "$zone_id" ]; then
    echo "âŒ Could not find Cloudflare zone for: $zone_name"
    return 1
  fi

  # Remove trailing dot from record name if present
  local clean_record_name="${record_name%.}"

  # URL encode the record name for the API call
  local encoded_record_name=$(printf '%s' "$clean_record_name" | jq -sRr @uri)

  # Check if CNAME record exists - try both with and without trailing dot
  local existing_record=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$zone_id/dns_records?type=CNAME&name=$encoded_record_name" \
    -H "Authorization: Bearer $api_token" \
    -H "Content-Type: application/json" | jq -r '.result[0].id' 2>/dev/null)

  # If not found, try with trailing dot
  if [ "$existing_record" = "null" ] || [ -z "$existing_record" ]; then
    local record_with_dot="${clean_record_name}."
    local encoded_record_with_dot=$(printf '%s' "$record_with_dot" | jq -sRr @uri)
    existing_record=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$zone_id/dns_records?type=CNAME&name=$encoded_record_with_dot" \
      -H "Authorization: Bearer $api_token" \
      -H "Content-Type: application/json" | jq -r '.result[0].id' 2>/dev/null)
  fi

  if [ "$existing_record" = "null" ] || [ -z "$existing_record" ]; then
    echo "false"
  else
    echo "true"
  fi
}

# Function to add CNAME record to Cloudflare
add_cloudflare_record() {
  local zone_name="$1"
  local record_name="$2"
  local record_value="$3"
  local api_token="$4"

  # Get zone ID
  local zone_id=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$zone_name" \
    -H "Authorization: Bearer $api_token" \
    -H "Content-Type: application/json" | jq -r '.result[0].id' 2>/dev/null)

  if [ "$zone_id" = "null" ] || [ -z "$zone_id" ]; then
    echo "âŒ Could not find Cloudflare zone for: $zone_name"
    return 1
  fi

  # Remove trailing dot from record name if present
  local clean_record_name="${record_name%.}"

  # Add CNAME record
  local response=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$zone_id/dns_records" \
    -H "Authorization: Bearer $api_token" \
    -H "Content-Type: application/json" \
    -d "{
      \"type\": \"CNAME\",
      \"name\": \"$clean_record_name\",
      \"content\": \"$record_value\",
      \"ttl\": 300,
      \"proxied\": false
    }")

  local success=$(echo "$response" | jq -r '.success' 2>/dev/null)
  if [ "$success" = "true" ]; then
    echo "âœ… Added CNAME record: $clean_record_name -> $record_value"
    return 0
  else
    local error=$(echo "$response" | jq -r '.errors[0].message' 2>/dev/null)
    # Check if it's a duplicate record error
    if echo "$error" | grep -q "already exists"; then
      echo "âœ… CNAME record already exists: $clean_record_name (this is expected)"
      return 0
    else
      echo "âŒ Failed to add CNAME record: $error"
      return 1
    fi
  fi
}

DOMAIN_BASE="{{sld}}.{{tld}}"

echo "ðŸ” Testing Cloudflare API connectivity..."
test_response=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$DOMAIN_BASE" \
  -H "Authorization: Bearer {{{githubVarsOpen}}} secrets.DNS_PROVIDER_KEY  {{{githubVarsClose}}}" \
  -H "Content-Type: application/json" 2>/dev/null || echo '{"success":false}')

if echo "$test_response" | jq -e '.success' >/dev/null 2>&1; then
  echo "âœ… Cloudflare API connectivity test successful"
else
  echo "âŒ Cloudflare API connectivity test failed. Skipping automatic DNS management."
  echo "DNS_AUTO_MANAGED=false" >> $GITHUB_OUTPUT
  exit 0
fi

# Cloudflare-specific certificate validation record processing
echo "ðŸ” Processing certificate validation records for Cloudflare..."
ui_records=$(get_validation_records "$UI_CERT_ARN" "us-east-1" "UI certificate")
if [ $? -eq 0 ] && [ -n "$ui_records" ]; then
  echo "$ui_records" | while IFS='|' read -r domain cname_name cname_value; do
    if [ -n "$domain" ] && [ -n "$cname_name" ] && [ -n "$cname_value" ]; then
      echo "  Processing: $domain -> $cname_name -> $cname_value"

      # Check if record already exists
      record_exists=$(check_cloudflare_record "$DOMAIN_BASE" "$cname_name" "{{{githubVarsOpen}}} secrets.DNS_PROVIDER_KEY  {{{githubVarsClose}}}")
      if [ "$record_exists" = "true" ]; then
        echo "  âœ… CNAME record already exists: $cname_name"
      else
        echo "  âž• Adding CNAME record: $cname_name -> $cname_value"
        add_cloudflare_record "$DOMAIN_BASE" "$cname_name" "$cname_value" "{{{githubVarsOpen}}} secrets.DNS_PROVIDER_KEY  {{{githubVarsClose}}}" || true
      fi
    fi
  done
fi

# Process API certificate validation records
echo "ðŸ” Processing API certificate validation records..."
api_records=$(get_validation_records "$API_CERT_ARN" "{{{githubVarsOpen}}} env.AWS_REGION  {{{githubVarsClose}}}" "API certificate")
if [ $? -eq 0 ] && [ -n "$api_records" ]; then
  echo "$api_records" | while IFS='|' read -r domain cname_name cname_value; do
    if [ -n "$domain" ] && [ -n "$cname_name" ] && [ -n "$cname_value" ]; then
      echo "  Processing: $domain -> $cname_name -> $cname_value"

      # Check if record already exists
      record_exists=$(check_cloudflare_record "$DOMAIN_BASE" "$cname_name" "{{{githubVarsOpen}}} secrets.DNS_PROVIDER_KEY  {{{githubVarsClose}}}")
      if [ "$record_exists" = "true" ]; then
        echo "  âœ… CNAME record already exists: $cname_name"
      else
        echo "  âž• Adding CNAME record: $cname_name -> $cname_value"
        add_cloudflare_record "$DOMAIN_BASE" "$cname_name" "$cname_value" "{{{githubVarsOpen}}} secrets.DNS_PROVIDER_KEY  {{{githubVarsClose}}}" || true
      fi
    fi
  done
fi

echo "âœ… Cloudflare DNS record management completed"
echo "DNS_AUTO_MANAGED=true" >> $GITHUB_OUTPUT
